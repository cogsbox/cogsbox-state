{"version":3,"file":"TRPCValidationLink.js","sources":["../src/TRPCValidationLink.ts"],"sourcesContent":["import { observable } from \"@trpc/server/observable\";\r\nimport type { AnyRouter } from \"@trpc/server\";\r\nimport type { TRPCLink } from \"@trpc/client\";\r\nimport type { Operation } from \"@trpc/client\";\r\nimport type { TRPCClientError } from \"@trpc/client\";\r\nimport { getGlobalStore } from \"./store\";\r\nimport type { Observer } from \"@trpc/server/observable\";\r\nexport const useCogsTrpcValidationLink = <\r\n  TRouter extends AnyRouter,\r\n>(passedOpts?: {\r\n  log?: boolean;\r\n}) => {\r\n  const addValidationError = getGlobalStore.getState().addValidationError;\r\n\r\n  const TrpcValidationLink = (): TRPCLink<TRouter> => {\r\n    return (opts) => {\r\n      return ({ next, op }: { next: any; op: Operation }) => {\r\n        return observable(\r\n          (observer: Observer<any, TRPCClientError<TRouter>>) => {\r\n            const unsubscribe = next(op).subscribe({\r\n              next(value: unknown) {\r\n                observer.next(value);\r\n              },\r\n              error(err: TRPCClientError<TRouter>) {\r\n                try {\r\n                  const errorObject = JSON.parse(err.message);\r\n                  if (passedOpts?.log) {\r\n                    console.log(\"errorObject\", errorObject);\r\n                  }\r\n                  if (Array.isArray(errorObject)) {\r\n                    errorObject.forEach(\r\n                      (error: { path: string[]; message: string }) => {\r\n                        const fullpath = `${op.path}.${error.path.join(\".\")}`;\r\n                        // In your TRPC link\r\n                        if (passedOpts?.log) {\r\n                          console.log(\"fullpath 1\", fullpath);\r\n                        }\r\n                        addValidationError(fullpath, error.message);\r\n                      }\r\n                    );\r\n                  } else if (\r\n                    typeof errorObject === \"object\" &&\r\n                    errorObject !== null\r\n                  ) {\r\n                    Object.entries(errorObject).forEach(([key, value]) => {\r\n                      const fullpath = `${op.path}.${key}`;\r\n                      if (passedOpts?.log) {\r\n                        console.log(\"fullpath 2\", fullpath);\r\n                      }\r\n                      addValidationError(fullpath, value as string);\r\n                    });\r\n                  }\r\n                } catch (e) {\r\n                  // Silently handle parse errors\r\n                }\r\n\r\n                observer.error(err);\r\n              },\r\n              complete() {\r\n                observer.complete();\r\n              },\r\n            });\r\n            return unsubscribe;\r\n          }\r\n        );\r\n      };\r\n    };\r\n  };\r\n  return TrpcValidationLink;\r\n};\r\n"],"names":["useCogsTrpcValidationLink","passedOpts","addValidationError","getGlobalStore","opts","next","op","observable","observer","value","err","errorObject","error","fullpath","key"],"mappings":";;AAOO,MAAMA,IAA4B,CAEvCC,MAEI;AACJ,QAAMC,IAAqBC,EAAe,SAAA,EAAW;AAwDrD,SAtD2B,MAClB,CAACC,MACC,CAAC,EAAE,MAAAC,GAAM,IAAAC,QACPC;AAAA,IACL,CAACC,MACqBH,EAAKC,CAAE,EAAE,UAAU;AAAA,MACrC,KAAKG,GAAgB;AACnB,QAAAD,EAAS,KAAKC,CAAK;AAAA,MACrB;AAAA,MACA,MAAMC,GAA+B;AACnC,YAAI;AACF,gBAAMC,IAAc,KAAK,MAAMD,EAAI,OAAO;AAC1C,UAAIT,GAAY,OACd,QAAQ,IAAI,eAAeU,CAAW,GAEpC,MAAM,QAAQA,CAAW,IAC3BA,EAAY;AAAA,YACV,CAACC,MAA+C;AAC9C,oBAAMC,IAAW,GAAGP,EAAG,IAAI,IAAIM,EAAM,KAAK,KAAK,GAAG,CAAC;AAEnD,cAAIX,GAAY,OACd,QAAQ,IAAI,cAAcY,CAAQ,GAEpCX,EAAmBW,GAAUD,EAAM,OAAO;AAAA,YAC5C;AAAA,UAAA,IAGF,OAAOD,KAAgB,YACvBA,MAAgB,QAEhB,OAAO,QAAQA,CAAW,EAAE,QAAQ,CAAC,CAACG,GAAKL,CAAK,MAAM;AACpD,kBAAMI,IAAW,GAAGP,EAAG,IAAI,IAAIQ,CAAG;AAClC,YAAIb,GAAY,OACd,QAAQ,IAAI,cAAcY,CAAQ,GAEpCX,EAAmBW,GAAUJ,CAAe;AAAA,UAC9C,CAAC;AAAA,QAEL,QAAY;AAAA,QAEZ;AAEA,QAAAD,EAAS,MAAME,CAAG;AAAA,MACpB;AAAA,MACA,WAAW;AACT,QAAAF,EAAS,SAAA;AAAA,MACX;AAAA,IAAA,CACD;AAAA,EAEH;AAMV;"}