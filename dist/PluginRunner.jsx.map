{"version":3,"file":"PluginRunner.jsx","sources":["../src/PluginRunner.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useState, useRef, useReducer } from 'react';\r\nimport { pluginStore } from './pluginStore';\r\nimport { isDeepEqual } from './utility';\r\nimport { createMetadataContext, toDeconstructedMethods } from './plugins';\r\nimport type { CogsPlugin } from './plugins';\r\nimport type { StateObject, UpdateTypeDetail } from './CogsState';\r\nimport { FormEventType } from './store';\r\n\r\nconst { setHookResult, removeHookResult } = pluginStore.getState();\r\n\r\nconst PluginInstance = React.memo(\r\n  ({\r\n    stateKey,\r\n    plugin,\r\n    options,\r\n    stateHandler,\r\n  }: {\r\n    stateKey: string;\r\n    plugin: CogsPlugin<any, any, any, any, any>;\r\n    options: any;\r\n    stateHandler: StateObject<any>;\r\n  }) => {\r\n    const [isInitialMount, setIsInitialMount] = useState(true);\r\n    const metadataContext = useMemo(\r\n      () => createMetadataContext(stateKey, plugin.name),\r\n      [stateKey, plugin.name]\r\n    );\r\n\r\n    const deconstructed = useMemo(\r\n      () => toDeconstructedMethods(stateHandler),\r\n      [stateHandler]\r\n    );\r\n\r\n    const hookContext = useMemo(\r\n      () => ({\r\n        stateKey,\r\n        pluginName: plugin.name,\r\n        isInitialMount,\r\n        options,\r\n        ...deconstructed,\r\n        ...metadataContext,\r\n      }),\r\n      [\r\n        stateKey,\r\n        plugin.name,\r\n        isInitialMount,\r\n        options,\r\n        deconstructed,\r\n        metadataContext,\r\n      ]\r\n    );\r\n\r\n    const hookData = plugin.useHook ? plugin.useHook(hookContext) : undefined;\r\n\r\n    useEffect(() => {\r\n      setIsInitialMount(false);\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n      if (plugin.useHook) setHookResult(stateKey, plugin.name, hookData);\r\n      else removeHookResult(stateKey, plugin.name);\r\n      return () => removeHookResult(stateKey, plugin.name);\r\n    }, [stateKey, plugin.name, !!plugin.useHook, hookData]);\r\n\r\n    const lastProcessedOptionsRef = useRef<any>();\r\n    const [isInitialTransform, setIsInitialTransform] = useState(true);\r\n\r\n    useEffect(() => {\r\n      if (plugin.transformState) {\r\n        if (!isDeepEqual(options, lastProcessedOptionsRef.current)) {\r\n          plugin.transformState({\r\n            stateKey,\r\n            pluginName: plugin.name,\r\n            options,\r\n            hookData,\r\n            isInitialTransform,\r\n            ...deconstructed,\r\n            ...metadataContext,\r\n          });\r\n          lastProcessedOptionsRef.current = options;\r\n          setIsInitialTransform(false);\r\n        }\r\n      }\r\n    }, [\r\n      stateKey,\r\n      plugin,\r\n      options,\r\n      hookData,\r\n      isInitialTransform,\r\n      deconstructed,\r\n      metadataContext,\r\n    ]);\r\n\r\n    const hookDataRef = useRef(hookData);\r\n    hookDataRef.current = hookData;\r\n\r\n    useEffect(() => {\r\n      if (!plugin.onUpdate) return;\r\n\r\n      const handleUpdate = (update: UpdateTypeDetail) => {\r\n        if (update.stateKey === stateKey) {\r\n          plugin.onUpdate!({\r\n            stateKey,\r\n            pluginName: plugin.name,\r\n            update,\r\n            path: update.path,\r\n            options,\r\n            hookData: hookDataRef.current,\r\n            ...deconstructed,\r\n            ...metadataContext,\r\n          });\r\n        }\r\n      };\r\n\r\n      const unsubscribe = pluginStore\r\n        .getState()\r\n        .subscribeToUpdates(handleUpdate);\r\n      return unsubscribe;\r\n    }, [stateKey, plugin, options, deconstructed, metadataContext]);\r\n\r\n    useEffect(() => {\r\n      if (!plugin.onFormUpdate) return;\r\n\r\n      const handleFormUpdate = (\r\n        event: FormEventType & { stateKey: string }\r\n      ) => {\r\n        if (event.stateKey === stateKey) {\r\n          const path = event.path;\r\n          plugin.onFormUpdate!({\r\n            stateKey,\r\n            pluginName: plugin.name,\r\n            path,\r\n            event: {\r\n              type: event.type,\r\n              value: event.value,\r\n              path,\r\n            },\r\n            options,\r\n            hookData: hookDataRef.current,\r\n            ...deconstructed,\r\n            ...metadataContext,\r\n          });\r\n        }\r\n      };\r\n\r\n      const unsubscribe = pluginStore\r\n        .getState()\r\n        .subscribeToFormUpdates(handleFormUpdate);\r\n      return unsubscribe;\r\n    }, [stateKey, plugin, options, deconstructed, metadataContext]);\r\n\r\n    return null;\r\n  }\r\n);\r\n/**\r\n * The main orchestrator component. It reads from the central pluginStore\r\n * and renders a `PluginInstance` controller for each active plugin.\r\n */\r\nexport function PluginRunner({ children }: { children: React.ReactNode }) {\r\n  // A simple way to force a re-render when the store changes.\r\n  const [, forceUpdate] = useReducer((c) => c + 1, 0);\r\n\r\n  // Subscribe to the store. When plugins or their options are added/removed,\r\n  // this component will re-render to update the list of PluginInstances.\r\n  useEffect(() => {\r\n    const unsubscribe = pluginStore.subscribe(forceUpdate);\r\n    return unsubscribe;\r\n  }, []);\r\n\r\n  const { pluginOptions, stateHandlers, registeredPlugins } =\r\n    pluginStore.getState();\r\n\r\n  return (\r\n    <>\r\n      {/*\r\n        This declarative mapping is the core of the solution.\r\n        React will now manage adding and removing `PluginInstance` components\r\n        as the application state changes, ensuring hooks are handled safely.\r\n      */}\r\n      {Array.from(pluginOptions.entries()).map(([stateKey, pluginMap]) => {\r\n        const stateHandler = stateHandlers.get(stateKey);\r\n        if (!stateHandler) {\r\n          return null; // Don't render a runner if the state handler isn't ready.\r\n        }\r\n\r\n        return Array.from(pluginMap.entries()).map(([pluginName, options]) => {\r\n          const plugin = registeredPlugins.find((p) => p.name === pluginName);\r\n          if (!plugin) {\r\n            return null; // Don't render if the plugin is not in the registered list.\r\n          }\r\n\r\n          // Render a dedicated, memoized controller for this specific plugin configuration.\r\n          return (\r\n            <PluginInstance\r\n              key={`${stateKey}:${pluginName}`}\r\n              stateKey={stateKey}\r\n              plugin={plugin}\r\n              options={options}\r\n              stateHandler={stateHandler}\r\n            />\r\n          );\r\n        });\r\n      })}\r\n\r\n      {children}\r\n    </>\r\n  );\r\n}\r\n"],"names":["setHookResult","removeHookResult","pluginStore","PluginInstance","React","stateKey","plugin","options","stateHandler","isInitialMount","setIsInitialMount","useState","metadataContext","useMemo","createMetadataContext","deconstructed","toDeconstructedMethods","hookContext","hookData","useEffect","lastProcessedOptionsRef","useRef","isInitialTransform","setIsInitialTransform","isDeepEqual","hookDataRef","handleUpdate","update","handleFormUpdate","event","path","PluginRunner","children","forceUpdate","useReducer","c","pluginOptions","stateHandlers","registeredPlugins","jsxs","Fragment","pluginMap","pluginName","p","jsx"],"mappings":"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"}